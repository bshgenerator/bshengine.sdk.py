name: Publish to TestPyPI

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-beta*'
      - 'v*.*.*-alpha*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      TWINE_USERNAME: __token__
      TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Install package dependencies
        run: |
          pip install -e ".[dev]"
      
      - name: Run tests
        run: pytest
      
      - name: Extract version and tag from git tag
        id: tag_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # Extract version and optional tag (v<version>[-<tag>[.<version>]])
          if [[ "$TAG_NAME" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)(-(alpha|beta)(\.[0-9]+)?)?$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG="${BASH_REMATCH[3]}"
            TAG_VERSION="${BASH_REMATCH[4]}"
          else
            echo "Tag format invalid: $TAG_NAME"
            exit 1
          fi

          if [[ -z "$TAG" ]]; then
            PYPI_TAG=""
            VERSION_SUFFIX="$VERSION"
          else
            PYPI_TAG="$TAG"
            # For PyPI, use format like 1.0.0-alpha or 1.0.0-alpha.1 (PEP 440 compatible)
            if [ -n "$TAG_VERSION" ]; then
              VERSION_SUFFIX="$VERSION-$TAG$TAG_VERSION"
            else
              VERSION_SUFFIX="$VERSION-$TAG"
            fi
          fi

          echo "version=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "pypi_tag=$PYPI_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION_SUFFIX"
          echo "pypi_tag=$PYPI_TAG"
        
      - name: Update pyproject.toml version
        run: |
          VERSION=${{ steps.tag_version.outputs.version }}
          CURRENT_VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          
          echo "Current version: $CURRENT_VERSION"
          echo "Target version: $VERSION"
          
          if [ "$CURRENT_VERSION" != "$VERSION" ]; then
            echo "Updating pyproject.toml version to: $VERSION"
            # Use sed to update version in pyproject.toml (Linux syntax for GitHub Actions)
            sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml
          else
            echo "Version already set to $VERSION, skipping update"
          fi
      
      - name: Update __init__.py version
        run: |
          VERSION=${{ steps.tag_version.outputs.version }}
          CURRENT_VERSION=$(grep -E '^__version__ = ' bshengine/__init__.py | sed "s/__version__ = \"\(.*\)\"/\1/")
          
          echo "Current __init__.py version: $CURRENT_VERSION"
          echo "Target version: $VERSION"
          
          if [ "$CURRENT_VERSION" != "$VERSION" ]; then
            echo "Updating __init__.py version to: $VERSION"
            # Use sed to update version in __init__.py (Linux syntax for GitHub Actions)
            sed -i "s/^__version__ = \".*\"/__version__ = \"$VERSION\"/" bshengine/__init__.py
          else
            echo "Version already set to $VERSION, skipping update"
          fi
      
      - name: Verify versions match
        run: |
          EXPECTED_VERSION=${{ steps.tag_version.outputs.version }}
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          INIT_VERSION=$(grep -E '^__version__ = ' bshengine/__init__.py | sed "s/__version__ = \"\(.*\)\"/\1/")
          
          echo "Expected version: $EXPECTED_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          echo "__init__.py version: $INIT_VERSION"
          
          if [ "$PYPROJECT_VERSION" != "$EXPECTED_VERSION" ] || [ "$INIT_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Version mismatch!"
            exit 1
          fi
      
      - name: Build package
        run: |
          python -m build
          echo "Build completed successfully"
      
      - name: Check package
        run: |
          twine check dist/*
          echo "Package check passed"
      
      - name: Publish to TestPyPI
        run: |
          VERSION=${{ steps.tag_version.outputs.version }}
          PACKAGE_NAME=$(grep -E '^name = ' pyproject.toml | sed 's/name = "\(.*\)"/\1/')
          PACKAGE_NAME="${PACKAGE_NAME}"

          echo "========================================="
          echo "Publishing to TestPyPI:"
          echo "  Package: $PACKAGE_NAME"
          echo "  Version: $VERSION"
          echo "  Repository: https://test.pypi.org"
          echo "========================================="
          
          twine upload --repository testpypi dist/*
          
          echo "Successfully published $PACKAGE_NAME@$VERSION to TestPyPI"
          echo "Install with: pip install --index-url https://test.pypi.org/simple/ $PACKAGE_NAME==$VERSION"
